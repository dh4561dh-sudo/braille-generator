<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Braille Transcriber Global</title>
<style>
  html, body { margin: 0; padding: 0; background: transparent !important; font-family: 'Segoe UI', system-ui, sans-serif; }
  .braille-card{ max-width:700px; margin:10px auto; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.08); border:1px solid #e5e7eb; }
  .braille-header{ background:#0f172a; color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; font-weight:600; }
  .braille-body{ padding:22px; }
  select,input,button{ width:100%; padding:12px; margin-bottom:15px; border-radius:6px; border:1px solid #cbd5e1; font-size:14px; box-sizing: border-box; }
  button{ background:#c5a059; color: #fff; border:none; font-weight:700; cursor:pointer; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  .notice{ background:#f8fafc; padding:12px; border-radius:6px; font-size:13px; margin-bottom:15px; line-height:1.4; }
  #status-log { font-size: 11px; text-align: center; margin-top: -10px; margin-bottom: 10px; color: #666; }
</style>
</head>
<body>

<div class="braille-card">
  <div class="braille-header">
    <div>⠃⠗⠇ Braille Transcriber Global</div>
    <div style="opacity:.7;font-size:12px">v2.6</div>
  </div>
  <div class="braille-body">
    <div class="notice" id="noticeBox"></div>
    <div id="status-log">Aguardando comando...</div>

    <label id="labelUrl"></label>
    <input type="text" id="urlInput"/>

    <label id="labelLang"></label>
    <select id="lang">
      <option value="pt">Português</option>
      <option value="en">English</option>
      <option value="es">Español</option>
      <option value="fr">Français</option>
      <option value="de">Deutsch</option>
      <option value="it">Italiano</option>
    </select>

    <button id="generateBtn">Gerar arquivo Braille</button>
  </div>
</div>

<script src="https://unpkg.com/liblouis@0.4.0/dist/liblouis.min.js"></script>

<script>
//<![CDATA[
const translations = {
    pt: { notice: `<strong>Aviso:</strong> Gerador de Braille normativo.`, labelUrl: "URL da postagem:", placeholder: "Cole a URL aqui", labelLang: "Idioma:", button: "Gerar arquivo Braille", loading: "Configurando Motor...", error: "Erro na tradução/acesso." },
    en: { notice: `<strong>Notice:</strong> Normative Braille generator.`, labelUrl: "Post URL:", placeholder: "Paste URL here", labelLang: "Language:", button: "Generate Braille file", loading: "Setting up Engine...", error: "Translation/Access error." }
};

const tableMap = { 
    pt: "pt-br.dis", 
    en: "en-ueb-g2.ctb", 
    es: "es.ctb", 
    fr: "fr-g2.ctb", 
    de: "de-g2.ctb", 
    it: "it.ctb" 
};

function updateLanguage(){
    const lang = document.getElementById("lang").value;
    const t = translations[lang] || translations['en'];
    document.getElementById("noticeBox").innerHTML = t.notice;
    document.getElementById("labelUrl").innerText = t.labelUrl;
    document.getElementById("urlInput").placeholder = t.placeholder;
    document.getElementById("labelLang").innerText = t.labelLang;
    document.getElementById("generateBtn").innerText = t.button;
}

document.getElementById("lang").addEventListener("change", updateLanguage);
updateLanguage();

document.getElementById("generateBtn").onclick = async function(){
    const btn = this;
    const lang = document.getElementById("lang").value;
    const t = translations[lang] || translations['en'];
    const url = document.getElementById("urlInput").value.trim();
    const log = document.getElementById("status-log");

    if(!url) return alert("Informe a URL");

    try {
        btn.disabled = true;
        log.innerText = t.loading;

        // 1. Verificar se a liblouis carregou
        if (!window.liblouis) {
            throw new Error("LibLouis não carregada. Verifique sua conexão.");
        }

        // 2. Tentar traduzir diretamente. 
        // A liblouis da unpkg já vem pré-configurada para buscar tabelas remotamente.
        log.innerText = "Buscando conteúdo...";
        const res = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
        if(!res.ok) throw new Error("Falha ao buscar conteúdo.");
        
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, "text/html");
        const contentNode = doc.querySelector(".post-body") || doc.querySelector("article") || doc.body;
        const textToTranslate = contentNode.innerText.trim();

        log.innerText = "Traduzindo para Braille...";
        // A liblouis faz o download automático da tabela ao chamar translateString
        const brailleResult = await liblouis.translateString(tableMap[lang], textToTranslate);

        // 3. Gerar arquivo
        const blob = new Blob([brailleResult], {type: "text/plain;charset=utf-8"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `compass_wealth_${lang}.brf`;
        link.click();
        
        log.innerText = "Sucesso!";
        log.style.color = "green";

    } catch (e) {
        console.error("Erro Crítico:", e);
        log.innerText = "Erro: " + e.message;
        log.style.color = "red";
        alert(t.error);
    } finally {
        btn.disabled = false;
        btn.innerText = t.button;
    }
};

// Auto-fill URL
const postUrl = new URLSearchParams(window.location.search).get("url");
if(postUrl) document.getElementById("urlInput").value = decodeURIComponent(postUrl);
//]]>
</script>
</body>
</html>
