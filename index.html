<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Braille Transcriber Global | Compass Wealth</title>

<style>
/* Reset e Variáveis de Estilo Geopolítico */
:root {
  --primary: #0f172a;
  --accent: #c5a059;
  --text: #334155;
  --bg: #f8fafc;
}

html, body {
  margin: 0;
  padding: 0;
  background: transparent !important;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  color: var(--text);
}

.braille-card {
  max-width: 650px;
  margin: 20px auto;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  border: 1px solid #e2e8f0;
}

.braille-header {
  background: var(--primary);
  color: #fff;
  padding: 16px 22px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.braille-header .title {
  font-weight: 700;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.braille-body {
  padding: 25px;
}

/* Feedback de carregamento */
#status-engine {
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 4px;
  background: #334155;
}
.engine-ok { background: #10b981 !important; }

.notice {
  background: #f1f5f9;
  padding: 15px;
  border-left: 4px solid var(--accent);
  border-radius: 4px;
  font-size: 13px;
  margin-bottom: 20px;
  line-height: 1.5;
}

label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--primary);
}

select, input, button {
  width: 100%;
  padding: 12px;
  margin-bottom: 20px;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  font-size: 14px;
  box-sizing: border-box;
  transition: all 0.2s;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1);
}

button {
  background: var(--accent);
  color: #fff;
  border: none;
  font-weight: 700;
  text-transform: uppercase;
  cursor: pointer;
  padding: 15px;
  margin-top: 10px;
}

button:hover {
  filter: brightness(1.1);
  transform: translateY(-1px);
}

button:active { transform: translateY(0); }

button:disabled {
  background: #cbd5e1;
  cursor: not-allowed;
}
</style>
</head>

<body>

<div class="braille-card">
  <div class="braille-header">
    <div class="title">⠃⠗⠇ Braille Transcriber Global</div>
    <div id="status-engine">Carregando Motor...</div>
  </div>

  <div class="braille-body">
    <div class="notice" id="noticeBox"></div>

    <label id="labelUrl" for="urlInput"></label>
    <input type="text" id="urlInput" placeholder="https://..." />

    <label id="labelLang" for="lang"></label>
    <select id="lang">
      <option value="pt">Português</option>
      <option value="en">English</option>
      <option value="es">Español</option>
      <option value="fr">Français</option>
      <option value="de">Deutsch</option>
      <option value="it">Italiano</option>
    </select>

    <button id="generateBtn" disabled>Aguarde o Motor...</button>
  </div>
</div>

<script src="https://unpkg.com/liblouis@0.4.0/dist/liblouis.min.js"></script>

<script>
//<![CDATA[
const translations = {
    pt: {
        notice: `<strong>Inclusão Digital:</strong> Este gerador converte análises geopolíticas em Braille normativo para impressão.`,
        labelUrl: "URL da postagem:",
        placeholder: "URL do post (Blogger/Site)",
        labelLang: "Idioma do conteúdo:",
        button: "Gerar arquivo Braille (.brf)",
        alertUrl: "Por favor, informe a URL da postagem.",
        alertError: "Erro ao acessar o conteúdo. Verifique a URL ou permissões.",
        alertEngine: "O motor Braille ainda não está pronto.",
        filename: "compass_wealth_braille.brf"
    },
    en: {
        notice: `<strong>Digital Inclusion:</strong> This generator converts geopolitical analyses into normative Braille for printing.`,
        labelUrl: "Post URL:",
        placeholder: "Post URL (Blogger/Site)",
        labelLang: "Content language:",
        button: "Generate Braille file (.brf)",
        alertUrl: "Please enter the post URL.",
        alertError: "Error accessing content. Check URL or permissions.",
        alertEngine: "Braille engine is not ready yet.",
        filename: "compass_wealth_braille.brf"
    }
    // ... (outros idiomas seguem a mesma lógica)
};

// Gerenciamento de Idioma
function updateLanguage() {
    const langVal = document.getElementById("lang").value;
    const t = translations[langVal] || translations['en'];
    document.getElementById("noticeBox").innerHTML = t.notice;
    document.getElementById("labelUrl").innerText = t.labelUrl;
    document.getElementById("urlInput").placeholder = t.placeholder;
    document.getElementById("labelLang").innerText = t.labelLang;
    if(!document.getElementById("generateBtn").disabled) {
        document.getElementById("generateBtn").innerText = t.button;
    }
}

document.getElementById("lang").addEventListener("change", updateLanguage);

// Inicialização da LibLouis
let engineReady = false;
async function initLouis() {
    try {
        // Pré-carregamento das tabelas essenciais
        await liblouis.loadTable("pt-br.dis");
        await liblouis.loadTable("en-ueb-g2.ctb");
        
        engineReady = true;
        const status = document.getElementById("status-engine");
        status.innerText = "Motor Pronto";
        status.classList.add("engine-ok");
        
        const btn = document.getElementById("generateBtn");
        btn.disabled = false;
        updateLanguage(); 
    } catch (e) {
        console.error("Erro no motor Braille:", e);
        document.getElementById("status-engine").innerText = "Erro no Motor";
    }
}

// Inicia motor
initLouis();

// Lógica de Geração
document.getElementById("generateBtn").onclick = async function() {
    const lang = document.getElementById("lang").value;
    const t = translations[lang] || translations['en'];
    const url = document.getElementById("urlInput").value.trim();

    if (!url) return alert(t.alertUrl);
    if (!engineReady) return alert(t.alertEngine);

    this.innerText = "Processando...";
    this.disabled = true;

    try {
        // Uso de proxy para contornar CORS
        const proxy = "https://api.allorigins.win/raw?url=";
        const res = await fetch(proxy + encodeURIComponent(url));
        if (!res.ok) throw new Error();
        
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, "text/html");

        // Seletores específicos para Blogger e sites de notícias
        const contentNode = doc.querySelector(".post-body") || 
                            doc.querySelector("article") || 
                            doc.querySelector(".entry-content") || 
                            doc.body;

        // Limpeza de texto: remove scripts, styles e excesso de espaços
        let cleanText = contentNode.innerText
            .replace(/\s\s+/g, ' ') 
            .replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gmi, "")
            .replace(/<style\b[^>]*>([\s\S]*?)<\/style>/gmi, "")
            .trim();

        const tables = { pt: "pt-br.dis", en: "en-ueb-g2.ctb", es: "es.ctb", fr: "fr-g2.ctb", de: "de-g2.ctb", it: "it.ctb" };
        
        const braille = await liblouis.translateString(tables[lang], cleanText);

        // Download do arquivo .brf
        const blob = new Blob([braille], { type: "text/plain;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = t.filename;
        a.click();

    } catch (e) {
        console.error(e);
        alert(t.alertError);
    } finally {
        this.disabled = false;
        updateLanguage();
    }
};

// Captura automática de URL se vier via parâmetro ?url=
const params = new URLSearchParams(window.location.search);
if (params.has("url")) {
    document.getElementById("urlInput").value = decodeURIComponent(params.get("url"));
}
//]]>
</script>

</body>
</html>
